<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Forum Title]</title>
    <style>
        /* --- Expanded Layout Styling --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 16px;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
        }
        a { color: #1877f2; text-decoration: none; }
        a:hover { text-decoration: underline; }
        h1 { font-size: 28px; }
        h2 { font-size: 22px; }
        hr { border: 0; border-top: 1px solid #ddd; margin: 20px 0; }
        input, textarea, button { font-family: inherit; font-size: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
        textarea { width: 100%; max-width: 600px; height: 150px; box-sizing: border-box; }
        button { background-color: #1877f2; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #166fe5; }
        button.secondary { background-color: #e4e6eb; color: #050505; }
        button.secondary:hover { background-color: #d8dbdf; }
        button:disabled { background-color: #ccd0d5; cursor: not-allowed; }

        /* Main structure */
        .container { max-width: 960px; margin: 0 auto; }
        .content-panel { padding: 20px; background-color: #fff; border: 1px solid #dddfe2; border-radius: 8px; }
        .view-header { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        .view-header a { font-size: 14px; }
        .view { display: none; }
        
        /* Auth & Search */
        #auth-bar { text-align: right; margin-bottom: 15px; font-size: 14px; min-height: 36px; }
        #auth-bar span { margin-right: 15px; }
        #login-container { display: flex; flex-direction: column; gap: 10px; max-width: 350px; }
        .auth-error { color: #fa383e; font-size: 14px; margin-top: 10px; }
        #search-bar-container { display: flex; gap: 10px; }
        #search-bar-container input { flex-grow: 1; }

        /* Table-like lists */
        .list-table { border-collapse: collapse; width: 100%; }
        .list-table th, .list-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .list-table th { background-color: #f7f7f7; font-size: 14px; color: #606770; }
        .list-table .row-main a { font-weight: 600; font-size: 18px; }
        .list-table .row-side { color: #606770; text-align: center; }

        /* Post Styling */
        .post-container { display: flex; gap: 15px; border-bottom: 1px solid #eee; padding: 15px 0; }
        .post-container:last-child { border-bottom: none; }
        .post-author { width: 180px; text-align: center; flex-shrink: 0; }
        .post-author .author-name { font-weight: bold; }
        .post-author .author-email { font-size: 12px; color: #606770; word-break: break-all; }
        .post-body { flex-grow: 1; }
        .post-meta { font-size: 12px; color: #606770; margin-bottom: 10px; }
        .post-content { line-height: 1.6; }
        .post-content img { max-width: 100%; border-radius: 6px; margin-top: 10px; }
        
        /* --- NEW Voting UI Styles --- */
        .vote-actions { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 4px; min-width: 40px; }
        .vote-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #8A8D91; padding: 0 8px; line-height: 1; }
        .vote-btn:hover { color: #333; }
        .vote-btn.voted-up { color: #1877f2; } /* Blue for upvote */
        .vote-btn.voted-down { color: #fa383e; } /* Red for downvote */
        .vote-score { font-size: 16px; font-weight: bold; color: #1c1e21; }

        /* Forms */
        .form-container { background-color: #f7f7f7; border: 1px solid #ddd; padding: 20px; margin-top: 20px; border-radius: 8px; }
        .form-row { margin-bottom: 15px; }
        .form-row label { display: block; font-weight: 600; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="auth-bar"></div>
        <div id="search-bar-container">
            <input type="search" id="search-input" placeholder="Search for threads by title...">
            <button id="search-btn">Search</button>
        </div>
        <hr>
        
        <div id="homepage-view" class="view content-panel"></div>
        <div id="section-view" class="view content-panel"></div>
        <div id="thread-view" class="view content-panel"></div>
        <div id="login-view" class="view content-panel"></div>
        <div id="search-results-view" class="view content-panel"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <script>
        // --- Firebase Configuration ---
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBUCkP-QMScZsXRSYtzzXscL-xi3eLjWIU",
  authDomain: "airy-forum.firebaseapp.com",
  projectId: "airy-forum",
  storageBucket: "airy-forum.firebasestorage.app",
  messagingSenderId: "1045870232743",
  appId: "1:1045870232743:web:3912220d3a935a447a8782",
  measurementId: "G-M6TZ7NYW2K"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const increment = (val) => firebase.firestore.FieldValue.increment(val);

        // --- DOM Elements & State ---
        const allViews = document.querySelectorAll('.view');
        const authBar = document.getElementById('auth-bar');
        
        // =================================================================
        // --- INITIALIZATION & AUTHENTICATION ---
        // =================================================================
        
        async function initializeDefaultSections() { /* ... unchanged ... */ }

        auth.onAuthStateChanged(user => {
            document.body.dataset.userId = user ? user.uid : '';
            if (user) {
                authBar.innerHTML = `<span>Logged in as: <strong>${user.email}</strong></span><button id="logout-btn" class="secondary">Logout</button>`;
                document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
            } else {
                authBar.innerHTML = `<button id="show-login-btn" class="secondary">Login / Sign Up</button>`;
                document.getElementById('show-login-btn').addEventListener('click', () => showView('login-view'));
            }
            route();
        });

        // =================================================================
        // --- ROUTING / VIEW MANAGEMENT ---
        // =================================================================

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeDefaultSections();
            document.getElementById('search-btn').addEventListener('click', () => {
                const query = document.getElementById('search-input').value;
                if (query) showView('search-results-view', { query });
            });
            window.addEventListener('popstate', route);
        });
        
        function route() { /* ... mostly unchanged ... */ }
        function showView(viewId, params = {}) { /* ... mostly unchanged ... */ }

        function updateUrl(path) { window.history.pushState({}, '', path); }
        
        // =================================================================
        // --- RENDER FUNCTIONS ---
        // =================================================================

        function renderHomepage() {
            updateUrl('index.html');
            const view = document.getElementById('homepage-view');
            view.innerHTML = `<h1>Hot Threads</h1><p>Trending topics from across the forums.</p><div id="hot-threads-list">Loading...</div>`;
            db.collection('threads').orderBy('hot_score', 'desc').limit(15).get().then(snapshot => {
                document.getElementById('hot-threads-list').innerHTML = createThreadListTable(snapshot);
            });
        }
        
        function renderSection(sectionId) { /* ... mostly unchanged ... */ }
        
        async function renderThread(sectionId, threadId) {
            // --- NEW: Increment view count and update hot score ---
            const threadRef = db.collection('threads').doc(threadId);
            const nowInSeconds = Math.floor(Date.now() / 1000);
            
            db.runTransaction(async (transaction) => {
                const threadDoc = await transaction.get(threadRef);
                if (!threadDoc.exists) return;
                const data = threadDoc.data();
                const score = data.score || 0;
                const views = (data.views || 0) + 1;
                const timestampSeconds = data.timestamp.seconds;
                const hot_score = calculateHotScore(score, views, timestampSeconds);
                
                transaction.update(threadRef, { views: increment(1), hot_score: hot_score });
            });
            
            // --- The rest of the function is similar but calls the new renderPost ---
            const view = document.getElementById('thread-view');
            // ... (HTML structure for thread view) ...
            
            db.collection('posts').where('threadId', '==', threadId).orderBy('timestamp', 'asc').onSnapshot(snapshot => {
                const postList = document.getElementById('post-list');
                postList.innerHTML = '';
                snapshot.forEach(doc => renderPost(doc, postList));
            });
        }
        
        async function renderPost(doc, container) {
            const post = doc.data();
            const postId = doc.id;
            const currentUser = auth.currentUser;

            const postEl = document.createElement('div');
            postEl.className = 'post-container';
            postEl.dataset.id = postId;
            postEl.dataset.type = 'posts'; // To reuse vote handler

            const imageTag = post.imageUrl ? `<img src="${post.imageUrl}" alt="User content">` : '';
            const postDate = post.timestamp ? post.timestamp.toDate().toLocaleString() : '...';
            
            let voteState = { up: '', down: '' };
            if (currentUser) {
                const voteDoc = await db.collection('posts').doc(postId).collection('votes').doc(currentUser.uid).get();
                if (voteDoc.exists) {
                    if (voteDoc.data().vote_type === 1) voteState.up = 'voted-up';
                    if (voteDoc.data().vote_type === -1) voteState.down = 'voted-down';
                }
            }
            
            postEl.innerHTML = `
                <div class="vote-actions">
                    <button class="vote-btn upvote ${voteState.up}" ${!currentUser ? 'disabled' : ''}>▲</button>
                    <span class="vote-score">${post.score || 0}</span>
                    <button class="vote-btn downvote ${voteState.down}" ${!currentUser ? 'disabled' : ''}>▼</button>
                </div>
                <div class="post-body">
                    <div class="post-author">
                        <div class="author-name">${post.authorEmail}</div>
                    </div>
                    <div class="post-meta">Posted on: ${postDate}</div>
                    <div class="post-content">
                        <p>${post.content.replace(/\n/g, '<br>')}</p>
                        ${imageTag}
                    </div>
                </div>
            `;
            container.appendChild(postEl);
        }
        
        function renderLogin() { /* ... unchanged ... */ }
        function renderSearchResults(query) { /* ... unchanged ... */ }

        // =================================================================
        // --- HELPER & UTILITY FUNCTIONS ---
        // =================================================================

        function createThreadListTable(snapshot) {
            let html = `<table class="list-table">
                <tr><th>Thread</th><th class="row-side">Score</th><th class="row-side">Views</th><th class="row-side">Author</th></tr>`;
            if (snapshot.empty) {
                return '<p>No threads found.</p>';
            }
            snapshot.forEach(doc => {
                const thread = doc.data();
                html += `
                    <tr>
                        <td class="row-main">
                            <a href="?section=${thread.sectionId}&thread=${doc.id}">${thread.title}</a>
                        </td>
                        <td class="row-side">${thread.score || 0}</td>
                        <td class="row-side">${thread.views || 0}</td>
                        <td class="row-side">${thread.authorEmail}</td>
                    </tr>
                `;
            });
            html += `</table>`;
            return html;
        }
        
        function calculateHotScore(score, views, timestampSeconds) {
            const order = Math.log10(Math.max(Math.abs(score), 1) + Math.log10(views || 1));
            const sign = score > 0 ? 1 : (score < 0 ? -1 : 0);
            const gravity = 1.8; // How fast posts fall in rank
            // The 45000 is a magic number from Reddit's original algorithm (seconds in 12.5 hours)
            const seconds = timestampSeconds - 1134028003;
            return (sign * order) + (seconds / 45000);
        }

        // =================================================================
        // --- EVENT HANDLERS ---
        // =================================================================

        async function handleNewThreadSubmit(e) { /* ... (adds score:1, views:1, etc. on creation) ... */ }
        async function handleReplySubmit(e) { /* ... (adds score:1 on creation) ... */ }
        
        async function handleVote(e) {
            const currentUser = auth.currentUser;
            if (!currentUser) {
                alert("You must be logged in to vote.");
                return;
            }
        
            const button = e.target;
            const container = button.closest('.post-container'); // Works for posts now
            const docId = container.dataset.id;
            const collectionName = 'posts'; // Simplified for this example, could be dynamic
        
            const voteDirection = button.classList.contains('upvote') ? 1 : -1;
        
            const docRef = db.collection(collectionName).doc(docId);
            const userVoteRef = docRef.collection('votes').doc(currentUser.uid);
        
            await db.runTransaction(async (transaction) => {
                const userVoteDoc = await transaction.get(userVoteRef);
                const currentVote = userVoteDoc.exists ? userVoteDoc.data().vote_type : 0;
        
                let scoreIncrement = 0;
        
                if (currentVote === voteDirection) { // User is undoing their vote
                    scoreIncrement = -voteDirection;
                    transaction.delete(userVoteRef);
                } else { // New vote or changing vote
                    scoreIncrement = voteDirection - currentVote; // If changing from -1 to 1, increment is 1 - (-1) = 2
                    transaction.set(userVoteRef, { vote_type: voteDirection });
                }
        
                if (scoreIncrement !== 0) {
                    transaction.update(docRef, { score: increment(scoreIncrement) });
                }
            });
        }
        
        // Add single, delegated event listener for votes
        document.querySelector('.container').addEventListener('click', e => {
            if (e.target.classList.contains('vote-btn')) {
                handleVote(e);
            }
        });

    </script>
</body>
</html>
