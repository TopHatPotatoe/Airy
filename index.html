<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airy Forum</title>
    <style>
        :root {
            /* Light Theme (Default) */
            --bg-color: #f4f4f4;
            --text-color: #333;
            --secondary-text-color: #666;
            --card-bg-color: #fff;
            --reply-bg-color: #f8f9fa;
            --border-color: #ddd;
            --primary-color: #007bff;
            --primary-hover-color: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover-color: #5a6268;
            --danger-color: #dc3545;
            --danger-hover-color: #c82333;
            --link-color: #007bff;
            --header-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --body-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            --box-shadow-hover: 0 4px 10px rgba(0,0,0,0.1);
        }

        body[data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --secondary-text-color: #b0b0b0;
            --card-bg-color: #1e1e1e;
            --reply-bg-color: #2a2a2a;
            --border-color: #333;
            --primary-color: #bb86fc;
            --primary-hover-color: #a764fc;
            --secondary-color: #4f4f4f;
            --secondary-hover-color: #616161;
            --danger-color: #cf6679;
            --danger-hover-color: #d47f8e;
            --link-color: #bb86fc;
        }
        
        body[data-theme="retro"] {
            --bg-color: #c0c0c0;
            --text-color: #000;
            --secondary-text-color: #000;
            --card-bg-color: #fff;
            --reply-bg-color: #f0f0f0;
            --border-color: #000;
            --primary-color: #000;
            --primary-hover-color: #333;
            --secondary-color: #a0a0a0;
            --secondary-hover-color: #888;
            --danger-color: #000;
            --danger-hover-color: #333;
            --link-color: #000;
            --header-font: 'Courier New', Courier, monospace;
            --body-font: 'Courier New', Courier, monospace;
            --border-radius: 0;
            --box-shadow: none;
            --box-shadow-hover: none;
        }

        /* --- General Styles --- */
        body { background-color: var(--bg-color); font-family: var(--body-font); color: var(--text-color); margin: 0; line-height: 1.6; }
        h1, h2, h3, h4 { font-family: var(--header-font); }
        .container { max-width: 90%; margin: 20px auto; padding: 20px; }
        .hidden { display: none !important; }

        /* --- Components --- */
        #auth-container { max-width: 400px; margin: 40px auto; padding: 20px; background: var(--card-bg-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        .auth-form h2 { text-align: center; margin-bottom: 20px; }
        input[type="email"], input[type="password"], input[type="text"], textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); box-sizing: border-box; font-family: inherit; background-color: var(--card-bg-color); color: var(--text-color); }
        textarea { resize: vertical; min-height: 100px; }
        button { width: 100%; padding: 12px; border: none; border-radius: var(--border-radius); background-color: var(--primary-color); color: var(--card-bg-color); cursor: pointer; font-family: inherit; font-size: 16px; }
        button:hover { background-color: var(--primary-hover-color); }
        #user-status { text-align: right; padding: 10px 0; }
        .user-actions button { background: transparent; color: var(--link-color); width: auto; padding: 0; font-size: 1em; margin-left: 15px; }
        
        .thread-item { background: var(--card-bg-color); padding: 20px; margin-bottom: 10px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color); }
        .thread-item:hover { transform: translateY(-3px); box-shadow: var(--box-shadow-hover); }
        .thread-title { font-size: 1.2em; font-weight: 500; color: var(--text-color); }
        .thread-author { font-size: 0.9em; color: var(--secondary-text-color); white-space: nowrap; padding-left: 20px; }
        
        .back-button { width: auto; padding: 8px 16px; font-size: 14px; background-color: var(--secondary-color); margin-bottom: 20px; }
        .back-button:hover { background-color: var(--secondary-hover-color); }
        .original-post { background: var(--card-bg-color); padding: 25px; margin-bottom: 20px; border-radius: var(--border-radius); }
        #op-title { margin-top: 0; }
        .original-post .username, .reply .username { font-weight: bold; margin-bottom: 8px; color: var(--link-color); }
        .original-post .content, .reply .content { white-space: pre-wrap; }
        .replies-container { margin-top: 20px; }
        .reply { padding: 15px; margin-bottom: 10px; background-color: var(--reply-bg-color); border-radius: var(--border-radius); }
        .reply-form, .create-post-area { margin-top: 30px; border-top: 2px solid var(--border-color); padding-top: 20px; }
        #new-thread-form { padding: 20px; background-color: var(--card-bg-color); border-radius: var(--border-radius); margin-top: 20px; }
        #cancel-post-button { background-color: var(--secondary-color); margin-top: 10px;}
        #cancel-post-button:hover { background-color: var(--secondary-hover-color); }

        #settings-view h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        #clear-all-posts-button { background-color: var(--danger-color); }
        #clear-all-posts-button:hover { background-color: var(--danger-hover-color); }
        .theme-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .theme-buttons button { width: auto; flex-grow: 1; }
    </style>
</head>
<body>

    <div class="container">
        <div id="user-status" class="hidden">
            Logged in as: <strong id="user-username"></strong>
            <span class="user-actions">
                <button id="settings-button">Settings</button>
                <button id="logout-button">Logout</button>
            </span>
        </div>
        <h1>Airy Forum</h1>

        <!-- AUTHENTICATION -->
        <div id="auth-container">
            <div id="login-form" class="auth-form"><h2>Login</h2><input type="email" id="login-email" placeholder="Email"><input type="password" id="login-password" placeholder="Password"><button id="login-button">Login</button></div>
            <div id="signup-form" class="auth-form"><h2>Sign Up</h2><input type="text" id="signup-username" placeholder="Username (public)"><input type="email" id="signup-email" placeholder="Email (private)"><input type="password" id="signup-password" placeholder="Password"><button id="signup-button">Sign Up</button></div>
        </div>

        <!-- VIEW 1: THREAD LIST -->
        <div id="thread-list-view" class="hidden">
            <div id="thread-list-container"></div>
            <div class="create-post-area">
                <button id="show-create-form-button">Create a New Thread</button>
                <div id="new-thread-form" class="hidden">
                    <h2>Create New Thread</h2>
                    <input type="text" id="new-thread-title" placeholder="Thread Title">
                    <textarea id="new-thread-content" placeholder="Write the main content for your thread..."></textarea>
                    <button id="new-thread-button">Post</button>
                    <button id="cancel-post-button">Cancel</button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: SINGLE THREAD -->
        <div id="single-thread-view" class="hidden">
            <button class="back-button">← All Threads</button>
            <div id="original-post-container"></div>
            <h3>Replies</h3>
            <div id="replies-container"></div>
            <div class="reply-form">
                <h4>Post a Reply</h4>
                <textarea id="reply-content" placeholder="Write your reply..."></textarea>
                <button id="submit-reply-button">Submit Reply</button>
            </div>
        </div>

        <!-- VIEW 3: SETTINGS -->
        <div id="settings-view" class="hidden">
            <button class="back-button">← All Threads</button>
            <h2>Settings</h2>
            <div class="setting-item">
                <h3>Theme</h3>
                <div class="theme-buttons">
                    <button data-theme="light">Light</button>
                    <button data-theme="dark">Dark</button>
                    <button data-theme="retro">Retro</button>
                </div>
            </div>
            <hr>
            <div class="setting-item" style="display:none;">
                <h3>Locked</h3>
                <p>This action is permanent and cannot be undone.</p>
                <button id="clear-all-posts-button">Clear All Posts & Replies</button>
            </div>
        </div>
    </div>

    <!-- TEMPLATES -->
    <template id="thread-item-template"><div class="thread-item"><div class="thread-title"></div><div class="thread-author"></div></div></template>
    <template id="original-post-template"><div class="original-post"><h2 id="op-title"></h2><p>by <strong class="username"></strong></p><hr><div class="content"></div></div></template>
    <template id="reply-template"><div class="reply"><div class="username"></div><div class="content"></div></div></template>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- THEME LOADER (Runs immediately) ---
        (function() {
            const savedTheme = localStorage.getItem('forum-theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        })();

        // --- FIREBASE CONFIG & INIT ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBX5uF_OV6UB-hVzBTaH2yLlhtzFhRmpXY",
  authDomain: "airy-forumv2.firebaseapp.com",
  projectId: "airy-forumv2",
  storageBucket: "airy-forumv2.firebasestorage.app",
  messagingSenderId: "541535481676",
  appId: "1:541535481676:web:7aead57267428ed81d69e9",
  measurementId: "G-P8WTYS16L0"
};
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const postsCollection = db.collection("posts");
        const usersCollection = db.collection("users");

        // --- GLOBAL VARS & DOM REFS ---
        let currentUserProfile = null;
        let currentThreadId = null;
        let repliesListener = null;

        const authContainer = document.getElementById('auth-container');
        const userStatus = document.getElementById('user-status');
        const userUsernameSpan = document.getElementById('user-username');
        const threadListView = document.getElementById('thread-list-view');
        const singleThreadView = document.getElementById('single-thread-view');
        const settingsView = document.getElementById('settings-view');
        const threadListContainer = document.getElementById('thread-list-container');
        const originalPostContainer = document.getElementById('original-post-container');
        const repliesContainer = document.getElementById('replies-container');
        const showCreateFormButton = document.getElementById('show-create-form-button');
        const newThreadForm = document.getElementById('new-thread-form');
        
        // --- VIEW MANAGEMENT ---
        function hideAllViews() {
            threadListView.classList.add('hidden');
            singleThreadView.classList.add('hidden');
            settingsView.classList.add('hidden');
        }
        function showThreadListView() {
            hideAllViews();
            threadListView.classList.remove('hidden');
            newThreadForm.classList.add('hidden');
            showCreateFormButton.classList.remove('hidden');
            currentThreadId = null;
            if (repliesListener) repliesListener();
        }
        function showSingleThreadView(threadId) {
            hideAllViews();
            singleThreadView.classList.remove('hidden');
            currentThreadId = threadId;
            loadSingleThread(threadId);
        }
        function showSettingsView() {
            hideAllViews();
            settingsView.classList.remove('hidden');
        }

        // --- AUTHENTICATION & USER STATE ---
        document.getElementById('signup-button').addEventListener('click', async () => { 
            const email = document.getElementById('signup-email').value; const password = document.getElementById('signup-password').value; const username = document.getElementById('signup-username').value.trim();
            if (!username) return alert('Please enter a username.');
            const usernameDoc = await usersCollection.where("username", "==", username).get();
            if (!usernameDoc.empty) return alert('This username is already taken.');
            try { const cred = await auth.createUserWithEmailAndPassword(email, password); await usersCollection.doc(cred.user.uid).set({ username: username }); } catch (error) { alert(error.message); }
        });
        document.getElementById('login-button').addEventListener('click', () => { const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; auth.signInWithEmailAndPassword(email, password).catch(error => alert(error.message)); });
        document.getElementById('logout-button').addEventListener('click', () => auth.signOut());
        document.getElementById('settings-button').addEventListener('click', showSettingsView);
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userDoc = await usersCollection.doc(user.uid).get();
                currentUserProfile = userDoc.data();
                userUsernameSpan.textContent = currentUserProfile.username;
                userStatus.classList.remove('hidden');
                authContainer.classList.add('hidden');
                loadAllThreads();
                showThreadListView();
            } else {
                currentUserProfile = null;
                userStatus.classList.add('hidden');
                authContainer.classList.remove('hidden');
                hideAllViews();
            }
        });

        // --- FORUM LOGIC (No major changes) ---
        function loadAllThreads() { /* ... no changes ... */
            postsCollection.orderBy("timestamp", "desc").onSnapshot(snapshot => {
                threadListContainer.innerHTML = "";
                snapshot.forEach(doc => {
                    const threadData = doc.data();
                    const threadItemTemplate = document.getElementById('thread-item-template');
                    const threadElement = threadItemTemplate.content.cloneNode(true);
                    threadElement.querySelector(".thread-title").textContent = threadData.title;
                    threadElement.querySelector(".thread-author").textContent = `by ${threadData.username}`;
                    threadElement.querySelector(".thread-item").addEventListener('click', () => showSingleThreadView(doc.id));
                    threadListContainer.appendChild(threadElement);
                });
            });
        }
        async function loadSingleThread(threadId) { /* ... no changes ... */
            const doc = await postsCollection.doc(threadId).get();
            const postData = doc.data();
            const originalPostTemplate = document.getElementById('original-post-template');
            originalPostContainer.innerHTML = '';
            const postElement = originalPostTemplate.content.cloneNode(true);
            postElement.querySelector('#op-title').textContent = postData.title;
            postElement.querySelector('.username').textContent = postData.username;
            postElement.querySelector('.content').textContent = postData.content;
            originalPostContainer.appendChild(postElement);
            repliesListener = postsCollection.doc(threadId).collection('replies').orderBy('timestamp', 'asc')
                .onSnapshot(replySnapshot => {
                    repliesContainer.innerHTML = '';
                    replySnapshot.forEach(replyDoc => {
                        const replyData = replyDoc.data();
                        const replyTemplate = document.getElementById('reply-template');
                        const replyElement = replyTemplate.content.cloneNode(true);
                        replyElement.querySelector('.username').textContent = replyData.username;
                        replyElement.querySelector('.content').textContent = replyData.content;
                        repliesContainer.appendChild(replyElement);
                    });
                });
        }
        
        // --- BUTTON ACTIONS ---
        showCreateFormButton.addEventListener('click', () => { showCreateFormButton.classList.add('hidden'); newThreadForm.classList.remove('hidden'); });
        document.getElementById('cancel-post-button').addEventListener('click', () => { newThreadForm.classList.add('hidden'); showCreateFormButton.classList.remove('hidden'); });
        document.getElementById('new-thread-button').addEventListener('click', () => { /* ... no changes ... */
            const titleInput = document.getElementById('new-thread-title'); const contentInput = document.getElementById('new-thread-content'); const title = titleInput.value.trim(); const content = contentInput.value.trim();
            if (title && content && currentUserProfile) {
                postsCollection.add({ userId: auth.currentUser.uid, username: currentUserProfile.username, title: title, content: content, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                titleInput.value = ""; contentInput.value = ""; newThreadForm.classList.add('hidden'); showCreateFormButton.classList.remove('hidden');
            } else { alert("Please provide both a title and content for your thread."); }
        });
        document.getElementById('submit-reply-button').addEventListener('click', () => { /* ... no changes ... */
            const content = document.getElementById('reply-content').value.trim();
            if (content && currentUserProfile && currentThreadId) {
                postsCollection.doc(currentThreadId).collection('replies').add({ userId: auth.currentUser.uid, username: currentUserProfile.username, content: content, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                document.getElementById('reply-content').value = '';
            }
        });
        document.querySelectorAll('.back-button').forEach(button => button.addEventListener('click', showThreadListView));

        // --- SETTINGS LOGIC ---
        function applyTheme(themeName) {
            document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('forum-theme', themeName);
        }
        document.querySelectorAll('.theme-buttons button').forEach(button => {
            button.addEventListener('click', (e) => {
                applyTheme(e.target.dataset.theme);
            });
        });
        document.getElementById('clear-all-posts-button').addEventListener('click', async () => { /* ... no changes ... */
            const pass = prompt("This is a destructive action. Please enter the admin password to proceed:"); if (pass !== "JonDangle") { alert("Incorrect password."); return; }
            if (!confirm("Are you sure you want to permanently delete all posts and replies? This cannot be undone.")) return;
            const clearButton = document.getElementById('clear-all-posts-button'); clearButton.textContent = "Deleting..."; clearButton.disabled = true;
            try {
                const postsSnapshot = await postsCollection.get(); const batch = db.batch();
                for (const postDoc of postsSnapshot.docs) {
                    const repliesSnapshot = await postDoc.ref.collection('replies').get();
                    repliesSnapshot.forEach(replyDoc => batch.delete(replyDoc.ref));
                    batch.delete(postDoc.ref);
                }
                await batch.commit(); alert("All posts and replies have been successfully deleted."); showThreadListView();
            } catch (error) { console.error("Error clearing posts: ", error); alert("An error occurred while clearing posts."); } finally { clearButton.textContent = "Clear All Posts & Replies"; clearButton.disabled = false; }
        });
    </script>
</body>
</html>
