<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Forum Title]</title>
    <style>
        /* --- BARE-BONES STYLING --- */
        body {
            font-family: Verdana, Arial, Helvetica, sans-serif;
            font-size: 13px;
            background-color: #FFF;
            color: #000;
            margin: 0;
            padding: 10px;
        }
        a { color: #004488; text-decoration: none; }
        a:hover { text-decoration: underline; }
        h1, h2 { font-size: 18px; margin: 0 0 10px 0; padding: 0; border-bottom: 1px solid #CCC; padding-bottom: 5px;}
        hr { border: 0; border-top: 1px solid #CCC; }
        input, textarea, button { font-family: inherit; font-size: inherit; margin: 0; }
        input[type="text"], input[type="email"], input[type="password"], input[type="search"], textarea { padding: 5px; border: 1px solid #999; }
        textarea { width: 400px; height: 120px; }
        button { background-color: #EFEFEF; border: 1px solid #CCC; padding: 4px 8px; cursor: pointer; }
        button:disabled { background-color: #F8F8F8; color: #999; cursor: not-allowed; }

        /* Main structure */
        .container { max-width: 960px; margin: 0 auto; border: 1px solid #C0C0C0; }
        .view { display: none; } /* Hide views by default */
        
        /* Headers & Navigation */
        .top-bar { padding: 8px 10px; background: #EFEFEF; border-bottom: 1px solid #C0C0C0; display: flex; justify-content: space-between; align-items: center; }
        #main-nav a { font-weight: bold; margin-right: 20px; }
        .view-header { background-color: #004488; color: #FFF; padding: 8px; font-weight: bold; }
        .view-header a { color: #FFF; }
        .search-container { padding: 10px; border-bottom: 1px solid #C0C0C0; }
        
        /* Table-like row styling */
        .list-header { display: flex; padding: 8px; font-weight: bold; background: #EFEFEF; border-bottom: 1px solid #E1E1E1; }
        .list-row { display: flex; padding: 8px; border-bottom: 1px solid #E1E1E1; align-items: center; }
        .list-row:nth-child(even) { background-color: #F7F7F7; }
        .list-row-main { flex-grow: 1; }
        .list-row-main .title { font-weight: bold; font-size: 14px; }
        .list-row-side { width: 80px; text-align: center; font-size: 12px; color: #333; }
        .list-row-side-wide { width: 150px; text-align: center; font-size: 12px; color: #333; }
        
        /* Post Styling */
        .post-container { display: flex; border-top: 1px solid #C0C0C0; padding: 10px 0; }
        .post-author { width: 150px; padding: 0 10px; text-align: center; flex-shrink: 0; }
        .post-author .author-name { font-weight: bold; }
        .post-author .author-email { font-size: 11px; color: #666; word-break: break-all; }
        .post-body { flex-grow: 1; padding: 0 10px; }
        .post-meta { font-size: 11px; color: #666; border-bottom: 1px solid #E1E1E1; padding-bottom: 8px; margin-bottom: 8px; }
        .post-content img { max-width: 100%; margin-top: 10px; }

        /* Voting UI */
        .vote-actions { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }
        .vote-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #777; padding: 0; }
        .vote-btn.voted-up { color: #004488; }
        .vote-btn.voted-down { color: #C00; }
        .vote-score { font-size: 14px; font-weight: bold; }

        /* Forms */
        .form-container { background-color: #F7F7F7; border: 1px solid #E1E1E1; padding: 15px; margin-top: 15px; }
        .form-row { margin-bottom: 8px; }
        .form-row label { display: block; font-weight: bold; margin-bottom: 4px; }
        .auth-error { color: #C00; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="top-bar">
            <div id="main-nav">
                <a href="#" data-view="homepage-view">Hot Threads (Home)</a>
                <a href="#" data-view="sections-list-view">Forum Sections</a>
            </div>
            <div id="auth-bar"></div>
        </div>
        <div class="search-container">
            <input type="search" id="search-input" placeholder="Search for threads...">
            <button id="search-btn">Search</button>
        </div>

        <!-- Views will be dynamically populated here -->
        <div id="homepage-view" class="view"></div>
        <div id="sections-list-view" class="view"></div>
        <div id="section-view" class="view"></div>
        <div id="thread-view" class="view"></div>
        <div id="login-view" class="view"></div>
        <div id="search-results-view" class="view"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <script>
        // --- Firebase Configuration ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBUCkP-QMScZsXRSYtzzXscL-xi3eLjWIU",
  authDomain: "airy-forum.firebaseapp.com",
  projectId: "airy-forum",
  storageBucket: "airy-forum.firebasestorage.app",
  messagingSenderId: "1045870232743",
  appId: "1:1045870232743:web:3912220d3a935a447a8782",
  measurementId: "G-M6TZ7NYW2K"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const increment = (val) => firebase.firestore.FieldValue.increment(val);

        // --- DOM Elements ---
        const allViews = document.querySelectorAll('.view');
        const authBar = document.getElementById('auth-bar');
        const mainNav = document.getElementById('main-nav');

        // =================================================================
        // --- INITIALIZATION & AUTHENTICATION ---
        // =================================================================

        async function initializeDefaultSections() {
            const sectionsRef = db.collection('sections');
            const snapshot = await sectionsRef.get();
            if (snapshot.empty) {
                console.log("No sections found. Creating default sections...");
                const batch = db.batch();
                const defaultSections = [
                    { name: "[General Discussion]", description: "[Talk about anything here.]" },
                    { name: "[Introductions]", description: "[New here? Say hello!]" }
                ];
                defaultSections.forEach(section => {
                    batch.set(sectionsRef.doc(), section);
                });
                await batch.commit();
            }
        }

        auth.onAuthStateChanged(user => {
            document.body.dataset.userId = user ? user.uid : '';
            if (user) {
                authBar.innerHTML = `<span>${user.email} | </span><a id="logout-link" href="#">Logout</a>`;
            } else {
                authBar.innerHTML = `<a id="login-link" href="#">Login / Sign Up</a>`;
            }
            route();
        });
        
        authBar.addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.id === 'login-link') showView('login-view');
            if (e.target.id === 'logout-link') auth.signOut();
        });

        mainNav.addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.dataset.view) {
                showView(e.target.dataset.view);
            }
        });

        // =================================================================
        // --- ROUTING / VIEW MANAGEMENT ---
        // =================================================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeDefaultSections();
            document.getElementById('search-btn').addEventListener('click', () => {
                const query = document.getElementById('search-input').value;
                if (query) showView('search-results-view', { query });
            });
            window.addEventListener('popstate', route);
        });

        function route() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('search')) showView('search-results-view', { query: params.get('search') });
            else if (params.has('thread')) showView('thread-view', { sectionId: params.get('section'), threadId: params.get('thread') });
            else if (params.has('section')) showView('section-view', { sectionId: params.get('section') });
            else showView('homepage-view');
        }

        function showView(viewId, params = {}) {
            allViews.forEach(v => v.style.display = 'none');
            const view = document.getElementById(viewId);
            view.style.display = 'block';
            
            const newUrl = new URL(window.location);
            newUrl.search = '';

            switch (viewId) {
                case 'homepage-view': renderHomepage(); break;
                case 'sections-list-view': renderSectionsList(); break;
                case 'login-view': renderLogin(); break;
                case 'section-view': 
                    renderSection(params.sectionId);
                    newUrl.searchParams.set('section', params.sectionId);
                    break;
                case 'thread-view':
                    renderThread(params.sectionId, params.threadId);
                    newUrl.searchParams.set('section', params.sectionId);
                    newUrl.searchParams.set('thread', params.threadId);
                    break;
                case 'search-results-view':
                    renderSearchResults(params.query);
                    newUrl.searchParams.set('search', params.query);
                    break;
            }
            if (window.location.href !== newUrl.href) {
                window.history.pushState({viewId, params}, '', newUrl.href);
            }
        }

        // =================================================================
        // --- RENDER FUNCTIONS (Injecting HTML into views) ---
        // =================================================================

        function renderHomepage() {
            const view = document.getElementById('homepage-view');
            view.innerHTML = `<div class="view-header">Hot Threads</div><div id="hot-threads-list">Loading...</div>`;
            db.collection('threads').orderBy('hot_score', 'desc').limit(20).get().then(snapshot => {
                document.getElementById('hot-threads-list').innerHTML = createThreadListHTML(snapshot);
            });
        }

        function renderSectionsList() {
            const view = document.getElementById('sections-list-view');
            view.innerHTML = `<div class="view-header">Forum Sections</div><div id="sections-list-content"></div>`;
            db.collection('sections').get().then(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const section = doc.data();
                    html += `<div class="list-row">
                                <div class="list-row-main">
                                    <a class="title" href="#" onclick="showView('section-view', {sectionId: '${doc.id}'})">${section.name}</a>
                                    <div>${section.description}</div>
                                </div>
                            </div>`;
                });
                document.getElementById('sections-list-content').innerHTML = html;
            });
        }
        
        function renderSection(sectionId) {
            const view = document.getElementById('section-view');
            db.collection('sections').doc(sectionId).get().then(doc => {
                const sectionName = doc.exists ? doc.data().name : '[Unknown Section]';
                const createThreadForm = auth.currentUser ? `
                    <div id="new-thread-form-container" class="form-container">
                        <h2>Create a New Thread</h2>
                        <form id="new-thread-form">
                            <div class="form-row"><label for="thread-title">Thread Title:</label><input type="text" id="thread-title" required></div>
                            <div class="form-row"><label for="thread-content">Post Content:</label><textarea id="thread-content" required></textarea></div>
                            <div class="form-row"><label for="thread-imageUrl">Image URL (Optional):</label><input type="text" id="thread-imageUrl"></div>
                            <button type="submit">Submit New Thread</button>
                        </form>
                    </div>` : '<div class="form-container">Please log in to create a thread.</div>';

                view.innerHTML = `<div class="view-header">${sectionName}</div>
                                <div id="thread-list-content">Loading...</div>
                                ${createThreadForm}`;

                if (auth.currentUser) {
                    view.querySelector('#new-thread-form').addEventListener('submit', (e) => handleNewThreadSubmit(e, sectionId));
                }

                db.collection('threads').where('sectionId', '==', sectionId).orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                    document.getElementById('thread-list-content').innerHTML = createThreadListHTML(snapshot);
                });
            });
        }

        async function renderThread(sectionId, threadId) {
            const view = document.getElementById('thread-view');
            const threadRef = db.collection('threads').doc(threadId);

            // Increment view count and update hot score
            db.runTransaction(async (transaction) => {
                const threadDoc = await transaction.get(threadRef);
                if (!threadDoc.exists) return;
                const data = threadDoc.data();
                const score = data.score || 0;
                const views = (data.views || 0) + 1;
                const timestampSeconds = data.timestamp ? data.timestamp.seconds : Math.floor(Date.now() / 1000);
                const hot_score = calculateHotScore(score, views, timestampSeconds);
                transaction.update(threadRef, { views: increment(1), hot_score: hot_score });
            });

            const threadDoc = await threadRef.get();
            const threadTitle = threadDoc.exists ? threadDoc.data().title : '[Unknown Thread]';
            
            const replyForm = auth.currentUser ? `
                <form id="reply-form" class="form-container">
                    <h2>Post a Reply</h2>
                    <div class="form-row"><label for="reply-content">Your Reply:</label><textarea id="reply-content" required></textarea></div>
                    <div class="form-row"><label for="reply-imageUrl">Image URL (Optional):</label><input type="text" id="reply-imageUrl"></div>
                    <button type="submit">Submit Reply</button>
                </form>` : '<div class="form-container">Please log in to reply.</div>';

            view.innerHTML = `<div class="view-header">${threadTitle}</div>
                              <div id="post-list"></div>
                              ${replyForm}`;
            
            if (auth.currentUser) {
                view.querySelector('#reply-form').addEventListener('submit', (e) => handleReplySubmit(e, threadId));
            }
            
            const postListContainer = view.querySelector('#post-list');
            db.collection('posts').where('threadId', '==', threadId).orderBy('timestamp', 'asc').onSnapshot(snapshot => {
                postListContainer.innerHTML = ''; // Clear old posts
                snapshot.forEach(doc => renderPost(doc, postListContainer));
            });
        }
        
        async function renderPost(doc, container) {
            const post = doc.data();
            const postId = doc.id;
            const currentUser = auth.currentUser;
            const postEl = document.createElement('div');
            postEl.className = 'post-container';

            const imageTag = post.imageUrl ? `<img src="${post.imageUrl}" alt="User content">` : '';
            const postDate = post.timestamp ? post.timestamp.toDate().toLocaleString() : '...';
            
            let voteState = { up: '', down: '' };
            if (currentUser) {
                const voteDoc = await db.collection('posts').doc(postId).collection('votes').doc(currentUser.uid).get();
                if (voteDoc.exists) {
                    if (voteDoc.data().vote_type === 1) voteState.up = 'voted-up';
                    if (voteDoc.data().vote_type === -1) voteState.down = 'voted-down';
                }
            }
            
            postEl.innerHTML = `
                <div class="post-author">
                    <div class="author-name">${post.authorEmail}</div>
                    <div class="vote-actions">
                        <button class="vote-btn upvote ${voteState.up}" data-post-id="${postId}" ${!currentUser ? 'disabled' : ''}>▲</button>
                        <span class="vote-score">${post.score || 0}</span>
                        <button class="vote-btn downvote ${voteState.down}" data-post-id="${postId}" ${!currentUser ? 'disabled' : ''}>▼</button>
                    </div>
                </div>
                <div class="post-body">
                    <div class="post-meta">Posted on: ${postDate}</div>
                    <div class="post-content">
                        <p>${post.content.replace(/\n/g, '<br>')}</p>
                        ${imageTag}
                    </div>
                </div>`;
            container.appendChild(postEl);
        }

        function renderLogin() {
            const view = document.getElementById('login-view');
            view.innerHTML = `
                <div class="view-header">Login or Sign Up</div>
                <div class="form-container">
                    <h2>Login</h2>
                    <form id="login-form">
                        <div class="form-row"><label for="login-email">Email:</label><input id="login-email" type="email" required></div>
                        <div class="form-row"><label for="login-password">Password:</label><input id="login-password" type="password" required></div>
                        <button type="submit">Login</button>
                        <p id="login-error" class="auth-error"></p>
                    </form>
                </div>
                <div class="form-container">
                    <h2>Sign Up</h2>
                    <form id="signup-form">
                        <div class="form-row"><label for="signup-email">Email:</label><input id="signup-email" type="email" required></div>
                        <div class="form-row"><label for="signup-password">Password:</label><input id="signup-password" type="password" required></div>
                        <button type="submit">Sign Up</button>
                        <p id="signup-error" class="auth-error"></p>
                    </form>
                </div>`;

            view.querySelector('#login-form').addEventListener('submit', handleLoginSubmit);
            view.querySelector('#signup-form').addEventListener('submit', handleSignupSubmit);
        }

        function renderSearchResults(query) {
            const view = document.getElementById('search-results-view');
            view.innerHTML = `<div class="view-header">Search Results for: "${query}"</div><div id="search-results-list">Loading...</div>`;
            db.collection('threads')
              .where('title_lowercase', '>=', query.toLowerCase())
              .where('title_lowercase', '<=', query.toLowerCase() + '\uf8ff')
              .orderBy('title_lowercase')
              .orderBy('timestamp', 'desc')
              .limit(20)
              .get().then(snapshot => {
                  document.getElementById('search-results-list').innerHTML = createThreadListHTML(snapshot);
              });
        }
        
        function createThreadListHTML(snapshot) {
            let html = `<div class="list-header">
                            <div class="list-row-main">Thread</div>
                            <div class="list-row-side">Score</div>
                            <div class="list-row-side">Views</div>
                            <div class="list-row-side-wide">Author</div>
                        </div>`;
            if (snapshot.empty) return html + '<div class="list-row"><div class="list-row-main">No threads found.</div></div>';
            snapshot.forEach(doc => {
                const thread = doc.data();
                html += `<div class="list-row">
                            <div class="list-row-main">
                                <a class="title" href="#" onclick="showView('thread-view', {sectionId: '${thread.sectionId}', threadId: '${doc.id}'})">${thread.title}</a>
                            </div>
                            <td class="list-row-side">${thread.score || 0}</td>
                            <td class="list-row-side">${thread.views || 0}</td>
                            <td class="list-row-side-wide">${thread.authorEmail}</td>
                        </div>`;
            });
            return html;
        }
        
        function calculateHotScore(score, views, timestampSeconds) {
            const order = Math.log10(Math.max(Math.abs(score), 1) + Math.log10(views || 1));
            const sign = score > 0 ? 1 : (score < 0 ? -1 : 0);
            return (sign * order) + (timestampSeconds / 45000);
        }
        
        // --- EVENT HANDLERS ---
        async function handleLoginSubmit(e) { /* ... */ }
        async function handleSignupSubmit(e) { /* ... */ }
        async function handleNewThreadSubmit(e, sectionId) { /* ... */ }
        async function handleReplySubmit(e, threadId) { /* ... */ }

        // --- DELEGATED VOTE HANDLER ---
        document.querySelector('.container').addEventListener('click', (e) => {
            const button = e.target.closest('.vote-btn');
            if (button) handleVote(button);
        });

        async function handleVote(button) {
            const currentUser = auth.currentUser;
            if (!currentUser) return alert("You must be logged in to vote.");
            const postId = button.dataset.postId;
            const voteDirection = button.classList.contains('upvote') ? 1 : -1;
            const docRef = db.collection('posts').doc(postId);
            const userVoteRef = docRef.collection('votes').doc(currentUser.uid);

            await db.runTransaction(async (transaction) => {
                const userVoteDoc = await transaction.get(userVoteRef);
                const postDoc = await transaction.get(docRef);
                if (!postDoc.exists) throw "Document does not exist!";

                const currentVote = userVoteDoc.exists ? userVoteDoc.data().vote_type : 0;
                let scoreIncrement = 0;

                if (currentVote === voteDirection) { // Undoing vote
                    scoreIncrement = -voteDirection;
                    transaction.delete(userVoteRef);
                } else { // New or changing vote
                    scoreIncrement = voteDirection - currentVote;
                    transaction.set(userVoteRef, { vote_type: voteDirection });
                }
                transaction.update(docRef, { score: increment(scoreIncrement) });
            });
        }
    </script>
</body>
</html>
