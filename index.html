<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Forum Title]</title>
    <style>
        /* --- Super Bare Bones Styling --- */
        body {
            font-family: Verdana, Arial, Helvetica, sans-serif;
            font-size: 13px;
            background-color: #FFF;
            color: #000;
            margin: 0;
            padding: 10px;
        }
        a { color: #004488; text-decoration: none; }
        a:hover { text-decoration: underline; }
        h1, h2 { font-size: 18px; margin: 0 0 10px 0; padding: 0; }
        hr { border: 0; border-top: 1px solid #CCC; }
        input, textarea, button { font-family: inherit; font-size: inherit; }
        textarea { width: 400px; height: 120px; }
        button { background-color: #EFEFEF; border: 1px solid #CCC; padding: 4px 8px; cursor: pointer; }

        /* Main wrapper */
        .forum-wrapper { max-width: 900px; margin: 0 auto; border: 1px solid #C0C0C0; }
        
        /* Shared Header Style */
        .view-header {
            background-color: #004488;
            color: #FFF;
            padding: 8px;
            font-weight: bold;
        }
        .view-header a { color: #FFF; }

        /* Content panels */
        .content-panel { padding: 10px; border-top: 1px solid #C0C0C0; }

        /* Hide views by default */
        #homepage-view, #section-view, #thread-view { display: none; }

        /* Table-like row styling */
        .row { display: flex; padding: 8px; border-bottom: 1px solid #E1E1E1; align-items: center; }
        .row:nth-child(even) { background-color: #F7F7F7; }
        .row-main { flex-grow: 1; }
        .row-side { width: 150px; text-align: center; }
        
        /* Post Styling (Dreamviews inspired) */
        .post-container { display: flex; border-top: 1px solid #C0C0C0; padding: 10px 0; }
        .post-author { width: 150px; padding: 0 10px; text-align: center; flex-shrink: 0; }
        .post-author .author-name { font-weight: bold; }
        .post-body { flex-grow: 1; padding: 0 10px; }
        .post-meta { font-size: 11px; color: #666; border-bottom: 1px solid #E1E1E1; padding-bottom: 8px; margin-bottom: 8px; }
        .post-content img { max-width: 100%; margin-top: 10px; }
        .post-actions { margin-top: 15px; }

        /* Forms */
        .form-container { background-color: #F7F7F7; border: 1px solid #E1E1E1; padding: 15px; margin-top: 15px; }
        .form-container h2 { border-bottom: 1px solid #DDD; padding-bottom: 8px; }
        .form-row { margin-bottom: 8px; }
        .form-row label { display: block; font-weight: bold; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div class="forum-wrapper">

        <!-- ===== Homepage View (List of Sections) ===== -->
        <div id="homepage-view">
            <div class="view-header">Forum Sections</div>
            <div id="section-list">
                <!-- Sections will be injected here -->
            </div>
        </div>

        <!-- ===== Section View (List of Threads) ===== -->
        <div id="section-view">
            <div class="view-header"><a href="index.html">← Home</a> / <span id="section-name-header"></span></div>
            <div id="thread-list">
                <!-- Threads will be injected here -->
            </div>
            <div class="content-panel">
                <button id="show-new-thread-form-btn">Create New Thread</button>
                <div id="new-thread-form-container" class="form-container" style="display: none;">
                    <h2>Create a New Thread</h2>
                    <form id="new-thread-form">
                        <div class="form-row">
                            <label for="thread-author">Your Name:</label>
                            <input type="text" id="thread-author" required>
                        </div>
                        <div class="form-row">
                            <label for="thread-title">Thread Title:</label>
                            <input type="text" id="thread-title" required>
                        </div>
                        <div class="form-row">
                            <label for="thread-content">Post Content:</label>
                            <textarea id="thread-content" required></textarea>
                        </div>
                        <div class="form-row">
                            <label for="thread-imageUrl">Image URL (Optional):</label>
                            <input type="text" id="thread-imageUrl">
                        </div>
                        <button type="submit">Submit New Thread</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ===== Thread View (List of Posts) ===== -->
        <div id="thread-view">
            <div class="view-header"><a href="index.html">← Home</a> / <a id="thread-back-link" href="#">Section</a> / <span id="thread-title-header"></span></div>
            <div id="post-list">
                <!-- Posts will be injected here -->
            </div>
            <div class="content-panel">
                 <form id="reply-form" class="form-container">
                    <h2>Post a Reply</h2>
                    <div class="form-row">
                        <label for="reply-author">Your Name:</label>
                        <input type="text" id="reply-author" required>
                    </div>
                    <div class="form-row">
                        <label for="reply-content">Your Reply:</label>
                        <textarea id="reply-content" required></textarea>
                    </div>
                    <div class="form-row">
                        <label for="reply-imageUrl">Image URL (Optional):</label>
                        <input type="text" id="reply-imageUrl">
                    </div>
                    <button type="submit">Submit Reply</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const increment = firebase.firestore.FieldValue.increment(1);

        // --- DOM Elements ---
        const homepageView = document.getElementById('homepage-view');
        const sectionView = document.getElementById('section-view');
        const threadView = document.getElementById('thread-view');

        // --- Data Collections ---
        // sections: { name, description }
        // threads: { sectionId, title, author, timestamp }
        // posts:   { threadId, author, content, imageUrl, upvotes, timestamp }

        // --- ROUTING ---
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const sectionId = params.get('section');
            const threadId = params.get('thread');

            if (sectionId && threadId) {
                showThreadView(sectionId, threadId);
            } else if (sectionId) {
                showSectionView(sectionId);
            } else {
                showHomepageView();
            }
        });

        // --- VIEW RENDERERS ---
        function showHomepageView() {
            homepageView.style.display = 'block'; sectionView.style.display = 'none'; threadView.style.display = 'none';
            const sectionList = document.getElementById('section-list');
            db.collection('sections').get().then(snapshot => {
                sectionList.innerHTML = '';
                snapshot.forEach(doc => {
                    const section = doc.data();
                    sectionList.innerHTML += `
                        <div class="row">
                            <div class="row-main">
                                <a href="?section=${doc.id}" style="font-weight: bold;">${section.name}</a>
                                <div style="font-size: 11px;">${section.description}</div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function showSectionView(sectionId) {
            homepageView.style.display = 'none'; sectionView.style.display = 'block'; threadView.style.display = 'none';
            const threadList = document.getElementById('thread-list');
            db.collection('sections').doc(sectionId).get().then(doc => {
                document.getElementById('section-name-header').textContent = doc.data().name;
            });
            db.collection('threads').where('sectionId', '==', sectionId).orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                threadList.innerHTML = `<div class="row" style="font-weight: bold; background: #EFEFEF;">
                                            <div class="row-main">Thread</div>
                                            <div class="row-side">Author</div>
                                        </div>`;
                snapshot.forEach(doc => {
                    const thread = doc.data();
                    threadList.innerHTML += `
                        <div class="row">
                            <div class="row-main"><a href="?section=${sectionId}&thread=${doc.id}">${thread.title}</a></div>
                            <div class="row-side">${thread.author}</div>
                        </div>
                    `;
                });
            });
        }

        function showThreadView(sectionId, threadId) {
            homepageView.style.display = 'none'; sectionView.style.display = 'none'; threadView.style.display = 'block';
            const postList = document.getElementById('post-list');
            // Set header links and titles
            db.collection('sections').doc(sectionId).get().then(doc => {
                const backLink = document.getElementById('thread-back-link');
                backLink.href = `?section=${sectionId}`;
                backLink.textContent = doc.data().name;
            });
            db.collection('threads').doc(threadId).get().then(doc => {
                document.getElementById('thread-title-header').textContent = doc.data().title;
            });

            // Listen for posts in this thread
            db.collection('posts').where('threadId', '==', threadId).orderBy('timestamp', 'asc').onSnapshot(snapshot => {
                postList.innerHTML = '';
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;
                    const imageTag = post.imageUrl ? `<img src="${post.imageUrl}" alt="User content">` : '';
                    const postDate = post.timestamp ? post.timestamp.toDate().toLocaleString() : '...';
                    postList.innerHTML += `
                        <div class="post-container" data-id="${postId}">
                            <div class="post-author">
                                <div class="author-name">${post.author}</div>
                            </div>
                            <div class="post-body">
                                <div class="post-meta">Posted on: ${postDate}</div>
                                <div class="post-content">
                                    <p>${post.content.replace(/\n/g, '<br>')}</p>
                                    ${imageTag}
                                </div>
                                <div class="post-actions">
                                    <button class="upvote-btn">Upvote</button>
                                    <span>${post.upvotes || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- EVENT LISTENERS ---

        // Show "New Thread" form
        document.getElementById('show-new-thread-form-btn').addEventListener('click', e => {
            const form = document.getElementById('new-thread-form-container');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        });

        // Handle "New Thread" submission
        document.getElementById('new-thread-form').addEventListener('submit', async e => {
            e.preventDefault();
            const sectionId = new URLSearchParams(window.location.search).get('section');
            const author = document.getElementById('thread-author').value;
            const title = document.getElementById('thread-title').value;
            const content = document.getElementById('thread-content').value;
            const imageUrl = document.getElementById('thread-imageUrl').value;
            
            // 1. Create the thread document
            const threadRef = await db.collection('threads').add({
                sectionId: sectionId,
                title: title,
                author: author,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            // 2. Create the first post in that thread
            await db.collection('posts').add({
                threadId: threadRef.id,
                author: author,
                content: content,
                imageUrl: imageUrl || null,
                upvotes: 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            // 3. Redirect to the new thread
            window.location.href = `?section=${sectionId}&thread=${threadRef.id}`;
        });

        // Handle "Reply" submission
        document.getElementById('reply-form').addEventListener('submit', e => {
            e.preventDefault();
            const threadId = new URLSearchParams(window.location.search).get('thread');
            const author = document.getElementById('reply-author').value;
            const content = document.getElementById('reply-content').value;
            const imageUrl = document.getElementById('reply-imageUrl').value;
            
            db.collection('posts').add({
                threadId: threadId,
                author: author,
                content: content,
                imageUrl: imageUrl || null,
                upvotes: 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('reply-form').reset();
            });
        });

        // Handle upvotes using event delegation
        document.getElementById('post-list').addEventListener('click', e => {
            if (e.target.classList.contains('upvote-btn')) {
                const postEl = e.target.closest('.post-container');
                const postId = postEl.dataset.id;
                db.collection('posts').doc(postId).update({ upvotes: increment });
            }
        });
    </script>
</body>
</html>
