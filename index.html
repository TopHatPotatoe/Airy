<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Forum Title]</title>
    <style>
        /* --- Super Bare Bones Styling --- */
        body {
            font-family: Verdana, Arial, Helvetica, sans-serif;
            font-size: 13px;
            background-color: #FFF;
            color: #000;
            margin: 0;
            padding: 10px;
        }
        a { color: #004488; text-decoration: none; }
        a:hover { text-decoration: underline; }
        h1, h2 { font-size: 18px; margin: 0 0 10px 0; padding: 0; }
        hr { border: 0; border-top: 1px solid #CCC; }
        input, textarea, button { font-family: inherit; font-size: inherit; }
        textarea { width: 400px; height: 120px; }
        button { background-color: #EFEFEF; border: 1px solid #CCC; padding: 4px 8px; cursor: pointer; }

        /* Main wrapper */
        .forum-wrapper { max-width: 900px; margin: 0 auto; border: 1px solid #C0C0C0; }
        
        /* Shared Header Style */
        .view-header {
            background-color: #004488;
            color: #FFF;
            padding: 8px;
            font-weight: bold;
        }
        .view-header a { color: #FFF; }

        /* Content panels */
        .content-panel { padding: 10px; border-top: 1px solid #C0C0C0; }

        /* Hide views by default */
        #homepage-view, #section-view, #thread-view { display: none; }

        /* Table-like row styling */
        .row { display: flex; padding: 8px; border-bottom: 1px solid #E1E1E1; align-items: center; }
        .row:nth-child(even) { background-color: #F7F7F7; }
        .row-main { flex-grow: 1; }
        .row-side { width: 150px; text-align: center; }
        
        /* Post Styling */
        .post-container { display: flex; border-top: 1px solid #C0C0C0; padding: 10px 0; }
        .post-author { width: 150px; padding: 0 10px; text-align: center; flex-shrink: 0; }
        .post-author .author-name { font-weight: bold; }
        .post-body { flex-grow: 1; padding: 0 10px; }
        .post-meta { font-size: 11px; color: #666; border-bottom: 1px solid #E1E1E1; padding-bottom: 8px; margin-bottom: 8px; }
        .post-content img { max-width: 100%; margin-top: 10px; }
        .post-actions { margin-top: 15px; }

        /* Forms */
        .form-container { background-color: #F7F7F7; border: 1px solid #E1E1E1; padding: 15px; margin-top: 15px; }
        .form-container h2 { border-bottom: 1px solid #DDD; padding-bottom: 8px; }
        .form-row { margin-bottom: 8px; }
        .form-row label { display: block; font-weight: bold; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div class="forum-wrapper">
        <div id="homepage-view"><!-- Content injected by JS --></div>
        <div id="section-view"><!-- Content injected by JS --></div>
        <div id="thread-view"><!-- Content injected by JS --></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <script>
        // --- Firebase Configuration ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBUCkP-QMScZsXRSYtzzXscL-xi3eLjWIU",
  authDomain: "airy-forum.firebaseapp.com",
  projectId: "airy-forum",
  storageBucket: "airy-forum.firebasestorage.app",
  messagingSenderId: "1045870232743",
  appId: "1:1045870232743:web:3912220d3a935a447a8782",
  measurementId: "G-M6TZ7NYW2K"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const increment = firebase.firestore.FieldValue.increment(1);

        // --- DOM Elements ---
        const homepageView = document.getElementById('homepage-view');
        const sectionView = document.getElementById('section-view');
        const threadView = document.getElementById('thread-view');

        // =================================================================
        // --- NEW: SELF-INITIALIZATION LOGIC ---
        // =================================================================
        async function initializeDefaultSections() {
            const sectionsRef = db.collection('sections');
            const snapshot = await sectionsRef.get();

            if (snapshot.empty) {
                console.log("No sections found. Creating default sections...");
                
                // Define the sections to create
                const defaultSections = [
                    {
                        name: "[General Discussion]",
                        description: "[Talk about anything here.]"
                    },
                    {
                        name: "[Introductions]",
                        description: "[New here? Say hello!]"
                    },
                    {
                        name: "[Help & Support]",
                        description: "[Ask for help or report issues.]"
                    }
                ];

                // Create a batch write to add all sections at once
                const batch = db.batch();
                defaultSections.forEach(section => {
                    const newSectionRef = sectionsRef.doc(); // Create a new doc with auto-ID
                    batch.set(newSectionRef, section);
                });

                // Commit the batch
                await batch.commit();
                console.log("Default sections created successfully.");

            } else {
                console.log("Sections already exist. Skipping initialization.");
            }
        }
        
        // --- ROUTING ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Run the initialization check first
            await initializeDefaultSections();

            // Then, proceed with routing as normal
            const params = new URLSearchParams(window.location.search);
            const sectionId = params.get('section');
            const threadId = params.get('thread');

            if (sectionId && threadId) {
                showThreadView(sectionId, threadId);
            } else if (sectionId) {
                showSectionView(sectionId);
            } else {
                showHomepageView();
            }
        });

        // --- VIEW RENDERERS ---
        function showHomepageView() {
            homepageView.style.display = 'block'; sectionView.style.display = 'none'; threadView.style.display = 'none';
            
            homepageView.innerHTML = `
                <div class="view-header">Forum Sections</div>
                <div id="section-list"></div>
            `;
            const sectionList = document.getElementById('section-list');
            db.collection('sections').onSnapshot(snapshot => {
                sectionList.innerHTML = '';
                snapshot.forEach(doc => {
                    const section = doc.data();
                    sectionList.innerHTML += `
                        <div class="row">
                            <div class="row-main">
                                <a href="?section=${doc.id}" style="font-weight: bold;">${section.name}</a>
                                <div style="font-size: 11px;">${section.description}</div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function showSectionView(sectionId) {
            homepageView.style.display = 'none'; sectionView.style.display = 'block'; threadView.style.display = 'none';

            sectionView.innerHTML = `
                <div class="view-header"><a href="index.html">← Home</a> / <span id="section-name-header"></span></div>
                <div id="thread-list"></div>
                <div class="content-panel">
                    <button id="show-new-thread-form-btn">Create New Thread</button>
                    <div id="new-thread-form-container" class="form-container" style="display: none;">
                        <h2>Create a New Thread</h2>
                        <form id="new-thread-form">
                            <div class="form-row"><label for="thread-author">Your Name:</label><input type="text" id="thread-author" required></div>
                            <div class="form-row"><label for="thread-title">Thread Title:</label><input type="text" id="thread-title" required></div>
                            <div class="form-row"><label for="thread-content">Post Content:</label><textarea id="thread-content" required></textarea></div>
                            <div class="form-row"><label for="thread-imageUrl">Image URL (Optional):</label><input type="text" id="thread-imageUrl"></div>
                            <button type="submit">Submit New Thread</button>
                        </form>
                    </div>
                </div>
            `;
            
            const threadList = document.getElementById('thread-list');
            db.collection('sections').doc(sectionId).get().then(doc => {
                document.getElementById('section-name-header').textContent = doc.exists ? doc.data().name : '[Unknown Section]';
            });
            db.collection('threads').where('sectionId', '==', sectionId).orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                threadList.innerHTML = `<div class="row" style="font-weight: bold; background: #EFEFEF;">
                                            <div class="row-main">Thread</div>
                                            <div class="row-side">Author</div>
                                        </div>`;
                if(snapshot.empty) {
                    threadList.innerHTML += `<div class="row"><div class="row-main">No threads here yet. Be the first!</div></div>`;
                }
                snapshot.forEach(doc => {
                    const thread = doc.data();
                    threadList.innerHTML += `
                        <div class="row">
                            <div class="row-main"><a href="?section=${sectionId}&thread=${doc.id}">${thread.title}</a></div>
                            <div class="row-side">${thread.author}</div>
                        </div>
                    `;
                });
            });

            // Re-add event listeners for the newly created DOM
            document.getElementById('show-new-thread-form-btn').addEventListener('click', () => {
                const form = document.getElementById('new-thread-form-container');
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            });
            document.getElementById('new-thread-form').addEventListener('submit', handleNewThreadSubmit);
        }

        function showThreadView(sectionId, threadId) {
            homepageView.style.display = 'none'; sectionView.style.display = 'none'; threadView.style.display = 'block';

            threadView.innerHTML = `
                <div class="view-header"><a href="index.html">← Home</a> / <a id="thread-back-link" href="#">Section</a> / <span id="thread-title-header"></span></div>
                <div id="post-list"></div>
                <div class="content-panel">
                     <form id="reply-form" class="form-container">
                        <h2>Post a Reply</h2>
                        <div class="form-row"><label for="reply-author">Your Name:</label><input type="text" id="reply-author" required></div>
                        <div class="form-row"><label for="reply-content">Your Reply:</label><textarea id="reply-content" required></textarea></div>
                        <div class="form-row"><label for="reply-imageUrl">Image URL (Optional):</label><input type="text" id="reply-imageUrl"></div>
                        <button type="submit">Submit Reply</button>
                    </form>
                </div>
            `;

            const postList = document.getElementById('post-list');
            db.collection('sections').doc(sectionId).get().then(doc => {
                const backLink = document.getElementById('thread-back-link');
                backLink.href = `?section=${sectionId}`;
                backLink.textContent = doc.exists ? doc.data().name : '[Unknown]';
            });
            db.collection('threads').doc(threadId).get().then(doc => {
                document.getElementById('thread-title-header').textContent = doc.exists ? doc.data().title : '[Unknown Thread]';
            });
            db.collection('posts').where('threadId', '==', threadId).orderBy('timestamp', 'asc').onSnapshot(snapshot => {
                postList.innerHTML = '';
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;
                    const imageTag = post.imageUrl ? `<img src="${post.imageUrl}" alt="User content">` : '';
                    const postDate = post.timestamp ? post.timestamp.toDate().toLocaleString() : '...';
                    postList.innerHTML += `
                        <div class="post-container" data-id="${postId}">
                            <div class="post-author"><div class="author-name">${post.author}</div></div>
                            <div class="post-body">
                                <div class="post-meta">Posted on: ${postDate}</div>
                                <div class="post-content"><p>${post.content.replace(/\n/g, '<br>')}</p>${imageTag}</div>
                                <div class="post-actions"><button class="upvote-btn">Upvote</button> <span>${post.upvotes || 0}</span></div>
                            </div>
                        </div>`;
                });
            });

            // Re-add event listeners
            document.getElementById('reply-form').addEventListener('submit', handleReplySubmit);
            document.getElementById('post-list').addEventListener('click', handlePostActions);
        }

        // --- EVENT HANDLERS (separated for clarity) ---

        async function handleNewThreadSubmit(e) {
            e.preventDefault();
            const sectionId = new URLSearchParams(window.location.search).get('section');
            const author = document.getElementById('thread-author').value;
            const title = document.getElementById('thread-title').value;
            const content = document.getElementById('thread-content').value;
            const imageUrl = document.getElementById('thread-imageUrl').value;
            
            const threadRef = await db.collection('threads').add({
                sectionId: sectionId, title: title, author: author, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection('posts').add({
                threadId: threadRef.id, author: author, content: content, imageUrl: imageUrl || null, upvotes: 0, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            window.location.href = `?section=${sectionId}&thread=${threadRef.id}`;
        }

        function handleReplySubmit(e) {
            e.preventDefault();
            const threadId = new URLSearchParams(window.location.search).get('thread');
            const author = document.getElementById('reply-author').value;
            const content = document.getElementById('reply-content').value;
            const imageUrl = document.getElementById('reply-imageUrl').value;
            
            db.collection('posts').add({
                threadId: threadId, author: author, content: content, imageUrl: imageUrl || null, upvotes: 0, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('reply-form').reset();
            });
        }

        function handlePostActions(e) {
            if (e.target.classList.contains('upvote-btn')) {
                const postId = e.target.closest('.post-container').dataset.id;
                db.collection('posts').doc(postId).update({ upvotes: increment });
            }
        }
    </script>
</body>
</html>
